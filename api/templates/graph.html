{% extends "layout.html" %}

{% block content %}
{{ dropzone.load_css() }}
{{ dropzone.style('border: 2px dashed #0087F7; margin: 5%; min-height: 100px;') }}


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css"
    integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">


<!-- <-- DataTables css -->
<link href="https://cdn.datatables.net/v/bs/dt-2.0.3/datatables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/2.0.3/css/dataTables.dataTables.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/1.7.0/css/buttons.dataTables.min.css" type="text/css" rel="stylesheet">
<link href="https://cdn.datatables.net/select/2.0.0/css/select.dataTables.css" rel="stylesheet">

<h3>{{id}}</h3>
<div id="{{ids}}"></div>

<!-- D3.js -->

<!--     <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script> -->


<!-- Plotly.js -->
<!-- <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> -->


<div class="container-fluid bg-1 text-center">
    <h4>Clustering inputs:</h4>
    <form class="form-group" method=post action="/graph">
        <br>
        <label for="taskid">GNPS task ID:</label><br>
        <input type="text" id="taskid" name="taskid" value=""><br>
        <br>
        <label for="metric">Dissimilarity measure:</label><br>
        <select class="form-control-sm" aria-label="Default select example" id="metric" name="metric" value="">
            <option value="">-- Select a dissimilatiry--</option>
            <option value="canberra">canberra</option>
            <option value="braycurtis">braycurtis</option>
            <option value="euclidean">euclidean</option>
            <option value="seuclidean">seuclidean</option>
            <option value="cityblock">cityblock</option>
            <option value="chebyshev">chebyshev</option>
            <option value="wminkowski">wminkowski</option>
            <option value="correlation">correlation</option>
            <option value="cosine">cosine</option>
            <option value="dice">dice</option>
            <option value="hamming">hamming</option>
            <option value="jaccard">jaccard</option>
            <option value="kulsinski">kulsinski</option>
            <option value="mahalanobis">mahalanobis</option>
            <option value="matching">matching</option>
            <option value="rogerstanimoto">rogerstanimoto</option>
            <option value="russellrao">russellrao</option>
            <option value="sokalmichener">sokalmichener</option>
            <option value="sokalsneath">sokalsneath</option>
            <option value="yule">yule</option>
        </select>
        <br>
        <br>
        <input class="btn btn-secondary" type="submit" value="Submit">
    </form>
</div>

<br>
<br>

{% if pcoa != None %}
<div class="container-fluid bg-1 text-center">
    <h3>PCoA analysis</h3>
    <object type="text/html" style="width:100%;height:500px;" data="{{url_for('static', filename=pcoa | safe) }}">
    </object>

</div>

<br>
<br>

<div class="form-group" style="text-align: center">
    <a href="{{url_for('downloadplot')}}">
        <button type="button" class="btn btn-dark">Download Emperor plot</button>
    </a>
</div class="container-fluid">

{% endif %}

<div id="csv-preview"></div>


<div class="container-fluid bg-1 text-center">
    <form id="my-form" action="{{ url_for('uploadForm') }}" enctype="multipart/form-data" method="post">
        {{ dropzone.create() }}
        <input type="hidden" name="filename" value="{{ pcoa }}">
        <input class="btn btn-secondary" type="submit" id="submit" value="Submit and Upload">
    </form>
</div>

{{ dropzone.load_js() }}
{{ dropzone.config() }}


<!-- dataTable scripts-->
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.datatables.net/2.0.3/js/dataTables.js"></script>

 
<script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/select/2.0.0/js/dataTables.select.js"></script>
<script src="https://cdn.datatables.net/select/2.0.0/js/select.dataTables.js"></script>

<!-- DataTables Checkboxes -->
<!-- <link type="text/css" href="//gyrocode.github.io/jquery-datatables-checkboxes/1.2.12/css/dataTables.checkboxes.css" rel="stylesheet" />
    <script type="text/javascript" src="//gyrocode.github.io/jquery-datatables-checkboxes/1.2.12/js/dataTables.checkboxes.min.js"></script> -->

<!-- PapaParse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.0/papaparse.min.js"></script>

<script>

    function processCSV(file) {
        Papa.parse(file, {
            complete: (result) => {
                if (result.data && result.data.length > 0) {
                    htmlTableGenerator(result.data)
                }
            }
        });
    }

    function htmlTableGenerator(content) {
        let csv_preview = document.getElementById('csv-preview');

        let html = '<table id="table" class="table table-condensed table-hover table-striped" style="width:100%">';

        if (content.length == 0 || typeof (content[0]) === 'undefined') {
            return null
        } else {
            const header = content[0];
            const data = content.slice(1);

            html += '<thead>';
            html += '<tr>';
            html += '<th></th>';
            header.forEach((colData) => {
                html += '<th>' + colData + '</th>';
            });
            html += '</tr>';
            html += '</thead>';
            html += '<tbody>';

            data.forEach((row) => {
                if (header.length === row.length) {
                    html += '<tr>';
                    html += '<td><input type="checkbox"></td>';
                    row.forEach((colData) => {
                        html += '<td>' + colData + '</td>';
                    });
                    html += '</tr>';
                }
            });

            html += '</tbody>';
            html += '</table>';

            csv_preview.innerHTML = html;

            initDataTable();
        }
    }


    function initDataTable() {
        $('#table').dataTable({
            scrollX: true,
             columnDefs: [
                {
                    orderable: false,
                    render: DataTable.render.select(),
                    targets: 0
                }
            ],
            select: {
                style: 'os',
                selector: 'td:first-child',
                headerCheckbox: false
            },
            dom: 'Bfrtip',
            buttons: [
                {
                    text: 'Delete Selected',
                    action: () => {
                        var table = $('#table').DataTable();
                        table.rows('.selected').remove().draw(false);
                    }
                },
                'csv', 'excel', 'pdf'
            ]
        })
    }

</script>


{{ dropzone.config(custom_init='dz = this; dz.on("addedfile", file => { processCSV(file); }); ') }}


{% endblock %}